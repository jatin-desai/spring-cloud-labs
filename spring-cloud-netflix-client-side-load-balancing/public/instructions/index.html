<!DOCTYPE html>


<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="alternate" href="/index.xml" type="application/rss+xml" title="Spring Cloud Netflix: Client Side Load Balancing">
		<link rel="icon" href="/spring-cloud-services-spring-cloud-netflix-client-side-load-balancing/favicon.ico">
		<title>Instructions - Spring Cloud Netflix: Client Side Load Balancing</title>
		<link rel="stylesheet" href="/spring-cloud-services-spring-cloud-netflix-client-side-load-balancing/css/highlight.js.min.css">
		<link rel="stylesheet" href="/spring-cloud-services-spring-cloud-netflix-client-side-load-balancing/css/bootstrap.min.css">
		<link rel="stylesheet" href="/spring-cloud-services-spring-cloud-netflix-client-side-load-balancing/css/bootstrap-theme.css">
		<link rel="stylesheet" href="/spring-cloud-services-spring-cloud-netflix-client-side-load-balancing/css/pui-v2.0.0/pivotal-ui.css">
		<link rel="stylesheet" href="/spring-cloud-services-spring-cloud-netflix-client-side-load-balancing/css/theme.css">
		<link rel="stylesheet" href="/spring-cloud-services-spring-cloud-netflix-client-side-load-balancing/css/pui-v2.0.0/pivotal-ui.js">

		<link rel="stylesheet" href="/spring-cloud-services-spring-cloud-netflix-client-side-load-balancing/css/bootie-docs.css">
	</head>

<body role="document">

	
	<nav class="navbar navbar-pivotal navbar-fixed-top">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand navbar-txt" href="/spring-cloud-services-spring-cloud-netflix-client-side-load-balancing/">Spring Cloud Netflix: Client Side Load Balancing </a>
			</div>
			<div id="navbar" class="navbar-collapse collapse">
				<ul class="nav navbar-nav">
					<li class="nav-pipe"> | </li>
			
				
				
					
					<li ><a class="navbar-txt" href="/spring-cloud-services-spring-cloud-netflix-client-side-load-balancing/goals">Goals</a></li>
				
					
					<li ><a class="navbar-txt" href="/spring-cloud-services-spring-cloud-netflix-client-side-load-balancing/setup">Setup</a></li>
				
					
					<li ><a class="navbar-txt" href="/spring-cloud-services-spring-cloud-netflix-client-side-load-balancing/instructions">Instructions</a></li>
				
					
					<li ><a class="navbar-txt" href="/spring-cloud-services-spring-cloud-netflix-client-side-load-balancing/resources">Resources</a></li>
				
			
				
				</ul>
			</div>
		</div>
	</nav>

<div class="container">
	<div class="row">
		
<div class="col-sm-14 doc-sidebar">
	<div class="sidebar-module">
		<div class="sidebar-toc">
			<h4>Table of Contents</h4>
			<ul>
				<li><strong><a href="#title">Instructions</a></strong></li>
			</ul>
			<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#exercises:22b1984e9055744bcb6b52260dfdfb71">Exercises</a>
<ul>
<li><a href="#start-the-config-server-service-registry-and-fortune-service:22b1984e9055744bcb6b52260dfdfb71">Start the  <code>config-server</code>,  <code>service-registry</code>, and <code>fortune-service</code></a></li>
<li><a href="#set-up-greeting-ribbon:22b1984e9055744bcb6b52260dfdfb71">Set up <code>greeting-ribbon</code></a></li>
<li><a href="#set-up-greeting-ribbon-rest:22b1984e9055744bcb6b52260dfdfb71">Set up <code>greeting-ribbon-rest</code></a></li>
<li><a href="#deploy-the-greeting-ribbon-rest-to-pcf:22b1984e9055744bcb6b52260dfdfb71">Deploy the <code>greeting-ribbon-rest</code> to PCF</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
		</div>
	</div>
</div>

		<div class="col-sm-24 doc-main">
			<main role="main">
				<article>
					<a id="title"></a>
					<h1 class="doc-entry-title">Instructions</h1>
					<div class="doc-entry-meta">
						<span><time datetime="2015-11-03">November 03, 2015</time></span>
					</div>
					<section>
						

<h2 id="exercises:22b1984e9055744bcb6b52260dfdfb71">Exercises</h2>

<h3 id="start-the-config-server-service-registry-and-fortune-service:22b1984e9055744bcb6b52260dfdfb71">Start the  <code>config-server</code>,  <code>service-registry</code>, and <code>fortune-service</code></h3>

<p>1) Start the <code>config-server</code> in a terminal window.  You may have terminal windows still open from previous labs.  They may be reused for this lab.</p>

<pre><code class="language-bash">$ cd $SPRING_CLOUD_SERVICES_LABS_HOME/config-server
$ mvn clean spring-boot:run
</code></pre>

<p>2) Start the <code>service-registry</code></p>

<pre><code class="language-bash">$ cd $SPRING_CLOUD_SERVICES_LABS_HOME/service-registry
$ mvn clean spring-boot:run
</code></pre>

<p>3) Start the <code>fortune-service</code></p>

<pre><code class="language-bash">$ cd $SPRING_CLOUD_SERVICES_LABS_HOME/fortune-service
$ mvn clean spring-boot:run
</code></pre>

<h3 id="set-up-greeting-ribbon:22b1984e9055744bcb6b52260dfdfb71">Set up <code>greeting-ribbon</code></h3>

<p><strong><em>No additions to the pom.xml</em></strong></p>

<p>In this case, we don&rsquo;t need to explicitly include Ribbon support in the <code>pom.xml</code>.  Ribbon support is pulled in through transitive dependencies (dependencies of the dependencies we have already defined).</p>

<p>1) Review the the following file: <code>$SPRING_CLOUD_SERVICES_LABS_HOME/greeting-ribbon/src/main/java/io/pivotal/greeting/GreetingController.java</code>.  Notice the <code>loadBalancerClient</code>.  It is a client side load balancer (Ribbon).  Review the <code>fetchFortuneServiceUrl()</code> method.  Ribbon is integrated with Eureka so that it can discover services as well.  Notice how the <code>loadBalancerClient</code> chooses a service instance by name.</p>

<pre><code class="language-java">@Controller
public class GreetingController {

	Logger logger = LoggerFactory
			.getLogger(GreetingController.class);




	@Autowired
	private LoadBalancerClient loadBalancerClient;

	@RequestMapping(&quot;/&quot;)
	String getGreeting(Model model){

		logger.debug(&quot;Adding greeting&quot;);
		model.addAttribute(&quot;msg&quot;, &quot;Greetings!!!&quot;);


		RestTemplate restTemplate = new RestTemplate();
        String fortune = restTemplate.getForObject(fetchFortuneServiceUrl(), String.class);

		logger.debug(&quot;Adding fortune&quot;);
		model.addAttribute(&quot;fortune&quot;, fortune);

		//resolves to the greeting.vm velocity template
		return &quot;greeting&quot;;
	}

	private String fetchFortuneServiceUrl() {
	    ServiceInstance instance = loadBalancerClient.choose(&quot;fortune-service&quot;);

	    logger.debug(&quot;uri: {}&quot;,instance.getUri().toString());
	    logger.debug(&quot;serviceId: {}&quot;, instance.getServiceId());


	    return instance.getUri().toString();
	}

}

</code></pre>

<p>2) Open a new terminal window.  Start the <code>greeting-ribbon</code> app.</p>

<pre><code class="language-bash">$ cd $SPRING_CLOUD_SERVICES_LABS_HOME/greeting-ribbon
$ mvn clean spring-boot:run
</code></pre>

<p>3) After the a few moments, check the <code>service-registry</code> <a href="http://localhost:8761">dashboard</a>.  Confirm the <code>greeting-ribbon</code> app is registered.</p>

<p>4) <a href="http://localhost:8080/">Browse</a> to the <code>greeting-ribbon</code> application.  Confirm you are seeing fortunes.  Refresh as desired.  Also review the terminal output for the <code>greeting-ribbon</code> app.  See the <code>uri</code> and <code>serviceId</code> being logged.</p>

<p>5) Stop the <code>greeting-ribbon</code> application.</p>

<h3 id="set-up-greeting-ribbon-rest:22b1984e9055744bcb6b52260dfdfb71">Set up <code>greeting-ribbon-rest</code></h3>

<p><strong><em>No additions to the pom.xml</em></strong></p>

<p>In this case, we don&rsquo;t need to explicitly include Ribbon support in the <code>pom.xml</code>.  Ribbon support is pulled in through transitive dependencies (dependencies of the dependencies we have already defined).</p>

<p>1) Review the the following file: <code>$SPRING_CLOUD_SERVICES_LABS_HOME/greeting-ribbon-rest/src/main/java/io/pivotal/greeting/GreetingController.java</code>.  Notice the <code>RestTemplate</code>.  It is not the usual <code>RestTemplate</code>, it is load balanced by Ribbon.  The <code>@LoadBalanced</code> annotation is a qualifier to ensure we get the load balanced <code>RestTemplate</code> injected.  This further simplifies application code.</p>

<pre><code class="language-java">@Controller
public class GreetingController {

	Logger logger = LoggerFactory
			.getLogger(GreetingController.class);




	@Autowired
	@LoadBalanced
	private RestTemplate restTemplate;

	@RequestMapping(&quot;/&quot;)
	String getGreeting(Model model){

		logger.debug(&quot;Adding greeting&quot;);
		model.addAttribute(&quot;msg&quot;, &quot;Greetings!!!&quot;);


  	String fortune = restTemplate.getForObject(&quot;http://fortune-service&quot;, String.class);

		logger.debug(&quot;Adding fortune&quot;);
		model.addAttribute(&quot;fortune&quot;, fortune);

		//resolves to the greeting.vm velocity template
		return &quot;greeting&quot;;
	}


}

</code></pre>

<p>2) Open a new terminal window.  Start the <code>greeting-ribbon-rest</code> app.</p>

<pre><code class="language-bash">$ cd $SPRING_CLOUD_SERVICES_LABS_HOME/greeting-ribbon-rest
$ mvn clean spring-boot:run
</code></pre>

<p>3) After the a few moments, check the <code>service-registry</code> <a href="http://localhost:8761">dashboard</a>.  Confirm the <code>greeting-ribbon-rest</code> app is registered.</p>

<p>4) <a href="http://localhost:8080/">Browse</a> to the <code>greeting-ribbon-rest</code> application.  Confirm you are seeing fortunes.  Refresh as desired.  Also review the terminal output for the <code>greeting-ribbon-rest</code> app.</p>

<p>5) When done stop the <code>config-server</code>, <code>service-registry</code>, <code>fortune-service</code> and <code>greeting-ribbon-rest</code> applications.</p>

<h3 id="deploy-the-greeting-ribbon-rest-to-pcf:22b1984e9055744bcb6b52260dfdfb71">Deploy the <code>greeting-ribbon-rest</code> to PCF</h3>

<p>1) Package and push the <code>greeting-ribbon-rest</code> application.</p>

<pre><code>$ mvn clean package
$ cf push greeting-ribbon-rest -p target/greeting-ribbon-rest-0.0.1-SNAPSHOT.jar -m 512M --random-route --no-start
</code></pre>

<p>2) Bind services for the <code>greeting-ribbon-rest</code> application.</p>

<pre><code class="language-bash">$ cf bind-service greeting-ribbon-rest config-server
$ cf bind-service greeting-ribbon-rest service-registry
</code></pre>

<p>You can safely ignore the <em>TIP: Use &lsquo;cf restage&rsquo; to ensure your env variable changes take effect</em> message from the CLI.  We don&rsquo;t need to restage at this time.</p>

<p>3) If using self signed certificates, set the <code>CF_TARGET</code> environment variable for the <code>greeting-ribbon-rest</code> application.</p>

<pre><code class="language-bash">$ cf set-env greeting-ribbon-rest CF_TARGET &lt;your api endpoint - make sure it starts with &quot;https://&quot;&gt;
</code></pre>

<p>You can safely ignore the <em>TIP: Use &lsquo;cf restage&rsquo; to ensure your env variable changes take effect</em> message from the CLI.  We don&rsquo;t need to restage at this time.</p>

<p>4) Start the <code>greeting-ribbon-rest</code> app.</p>

<pre><code class="language-bash">$ cf start greeting-ribbon-rest
</code></pre>

<p>5) After the a few moments, check the <code>service-registry</code>.  Confirm the <code>greeting-ribbon-rest</code> app is registered.</p>

<p>6) Refresh the <code>greeting-ribbon-rest</code> <code>/</code> endpoint.</p>

<p><strong>Note About This Lab</strong></p>

<p>If services (e.g. <code>fortune-service</code>) are registering using the first Cloud Foundry URI (using the <code>route</code> registration method) this means that requests to them are being routed through the <code>router</code> and subsequently load balanced at that layer.  Therefore, client side load balancing doesn&rsquo;t occur.</p>

<p>Pivotal Cloud Foundry has recently added support for allowing cross container communication.  This will allow applications to communicate with each other without passing through the <code>router</code>.  As applied to client-side load balancing, services such as <code>fortune-service</code> would register with Eureka using their container IP addresses.  Allowing clients to reach them without going through the <code>router</code>.  This is known as using the <code>direct</code> registration method.</p>

<p>For more details, please read the <a href="http://docs.pivotal.io/spring-cloud-services/service-registry/registering-a-service.html">following</a>.</p>

					</section>
				</article>
			</main>
		</div> 


	</div> 
</div>

<hr />
<div class="container">
	<div class="row">
		<div class="col-sm-8">
			<p class="doc-footer-em"><a href="#">Back to TOP</a></p>
		</div>
	</div>

</div> 

<footer class="doc-footer">
	
	<p>Â© Copyright Pivotal. All rights reserved.</p>
</footer>



<script src="/spring-cloud-services-spring-cloud-netflix-client-side-load-balancing/js/jquery-1.11.2.min.js"></script>
<script src="/spring-cloud-services-spring-cloud-netflix-client-side-load-balancing/js/bootstrap.min.js"></script>

<script src="/spring-cloud-services-spring-cloud-netflix-client-side-load-balancing/js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="/spring-cloud-services-spring-cloud-netflix-client-side-load-balancing/js/ie10-viewport-bug-workaround.js"></script>

<script data-no-instant>document.write('<script src="http://'
        + (location.host || 'localhost').split(':')[0]
		+ ':1313/livereload.js?mindelay=10"></'
        + 'script>')</script></body>
</html>

